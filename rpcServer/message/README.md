# 消息服务
## 1、消息的发送
消息发送请求由前端发送过来后，经过网关解析出发送者的id，分配给消息服务进行处理，消息服务处理的流程如下：
1. 验证消息记录的合法性；
2. 消息记录存入数据库，并将该条记录的自增id"带出来"；
3. 将消息记录序列化后以秒级时间戳为score存入redis的排序集合中，设置排序集合缓存的过期时间为7天；
4. 判断当前用户之间存储在redis缓存中的聊天记录是否超过阈值（默认200条），超过则删除距离当前时间最久的25%左右的消息记录；

## 2、消息的查询
消息查询请求由前端发送过来后，经过网关解析出查询者的id，分配给消息服务进行处理，消息服务处理的流程如下：
1. 统计当前用户间缓存在redis中的消息记录数量；
2. 缓存中消息记录数量为0，则直接去mysql中查询，并将查询结果返回；
3. 缓存中消息记录数量不为0，则检查请求的查询起始时间是否小于redis缓存中最早记录的时间；
   + 小于则说明当前缓存数据无法cover请求的消息记录，因此需要去查询无法cover的那一部分数据，能cover的那一部分还是在缓存中查找，将两次查询结果拼接；
   + 大于则说明当前缓存能够全部cover查询消息的请求，则直接在缓存中查找即可；
4. 将查询得到的消息记录映射到响应中，返回结果；